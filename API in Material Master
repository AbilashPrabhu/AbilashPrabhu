  METHOD IF_HTTP_EXTENSION~HANDLE_REQUEST.



    DATA : DATE TYPE SY-DATUM.

    SELECT

      A~MATNR AS MATERIAL,
      B~MAKTX AS DESCRIPTION,
      A~MEINS AS UNITOFMEASURE,
      A~BISMT AS OLDMATERIALNUMBER,
      A~SPART AS DIVISION,
      A~MSTAE AS XPLANTMATSTATUS,
      A~MATKL AS MATERIALGROUP,
      C~WGBEZ AS MATERIALGROUPNAME,
      A~EXTWG AS EXTERNALMATERIALGROUP,
      D~EWBEZ AS EXTERNALMATERIALGROUPNAME,
      CAST( A~BRGEW AS CHAR ) AS GROSSWEIGHT,
      CAST( A~NTGEW AS CHAR ) AS NETWEIGHT,
      CAST( A~GEWEI AS CHAR ) AS WEIGHTUNIT,
      B~MAKTG AS LONGDESCRIPTION,
      CAST( A~ZZPRIPACKQTY AS CHAR  ) AS PRIMARYPACKQTY,
      CAST( A~ZZSECPACKQTY AS CHAR  ) AS SECONDARYPACKQTY,
      CAST( A~ZZLOOPACKQTY AS CHAR  ) AS MASTERPACKQTY,
      A~WRKST AS BASICMATERIAL,
      A~NORMT AS INDSTDDESC,
      M~GRPTYPE AS PRODUCTGROUPTYPE,
      CAST( B~MAKTX AS CHAR ) AS PRODUCTGROUPTYPEDESC,
      M~GROUPVALUE AS PRODUCTGROUP,
      M~GRPTYPE AS PRODUCTGROUPTYPE1,
      CAST( B~MAKTX AS CHAR ) AS PRODUCTGROUPTYPEDESC1,
      M~GROUPVALUE AS PRODUCTGROUP1,
      M~GRPTYPE AS PRODUCTGROUPTYPE2,
      CAST( B~MAKTX AS CHAR ) AS PRODUCTGROUPTYPEDESC2,
      M~GROUPVALUE AS PRODUCTGROUP2,
      M~GRPTYPE AS PRODUCTGROUPTYPE3,
      CAST( B~MAKTX AS CHAR ) AS PRODUCTGROUPTYPEDESC3,
      M~GROUPVALUE AS PRODUCTGROUP3,
      E~VKORG AS SALESORGANIZATION,
      E~VTWEG  AS DISTRIBUTIONCHANNEL,
      CAST( E~AUMNG AS CHAR ) AS MINORDERQTY,
      A~MSTAV AS XDISTCHAINSTATUS,
      E~VMSTA AS DCHAINSPECSTATUS,
      F~WERKS AS PLANT,
      G~NAME1 AS PLANTNAME,
      F~PRCTR AS PROFITCENTER,
      H~KTEXT AS PROFITCENTERNAME,
      F~STEUC AS CONTROLCODE,
      F~EKGRP AS PURCHASINGGROUP,
      F~MMSTA AS PLANTSPMATLSTATUS,
      F~DISMM AS MRPTYPE,
      CAST( F~MINBE AS CHAR ) AS REORDERPOINT,
      F~DISPO AS MRPCONTROLLER,
      F~BESKZ AS PROCUREMENTTYPE,
      F~SOBSL AS SPECIALPROCUREMENT,
      F~RGEKZ AS BACKFLUSH,
      F~LGPRO AS PRODSTORAGELOCATION,
      S~LGPBE AS STORAGEBIN,
      F~STRGR AS STRATEGYGROUP,
      F~PERKZ AS PERIODINDICATOR,
      N~PRMOD AS FORECASTMODEL,
      CAST(  J~STPRS AS CHAR ) AS STANDARDPRICE,
      CAST(  J~VERPR AS CHAR ) AS PERUNITPRICE,
      CAST(  J~STPRV AS CHAR ) AS PREVIOUSPRICE,
*      CAST(  j~laepr AS CHAR ) AS lastpricechange,
      J~LAEPR  AS LASTPRICECHANGE,
      F~AUSME AS UNITOFISSUE,
      F~QMATV AS INSPECTIONSETUP,  ""c by prathi"
      A~QMPUR AS QMINPROCURACTIVE,
      F~SSQSS AS QMCONTROL,
      P~ART   AS INSPTYP,
      Q~KURZTEXT  AS INSPTYPDESC,
      A~MTART AS MATERIALTYPE,
      I~MTBEZ AS MATERIALTYPEDESC,
      A~LVORM AS DELETIONFLAG,
      K~VTEXT AS SALESORGANISATIONNAME,
      L~VTEXT AS DISTRIBUTIONNAME,
      CAST( R~UMREN AS CHAR ) AS X,
      R~MEINH AS AUN,
      CAST( R~UMREZ AS CHAR ) AS Y,
      R~MEINH AS BUN

      FROM MARA AS A
      LEFT JOIN MAKT AS B ON B~MATNR = A~MATNR AND B~SPRAS = 'E'
      LEFT JOIN T023T AS C ON C~MATKL = A~MATKL AND C~SPRAS = 'E'
      LEFT JOIN TWEWT AS D ON D~EXTWG = A~EXTWG AND D~SPRAS = 'E'
      LEFT JOIN MVKE AS E ON E~MATNR = A~MATNR
      LEFT JOIN MARC AS F ON F~MATNR = A~MATNR
      LEFT JOIN T001W AS G ON G~WERKS =  F~WERKS
      LEFT JOIN CEPCT AS H ON H~PRCTR =  F~PRCTR AND H~SPRAS = 'E'
      LEFT JOIN T134T AS I ON I~MTART = A~MTART AND I~SPRAS = 'E'
      LEFT JOIN MBEW AS J ON J~MATNR = A~MATNR AND J~BWKEY = F~WERKS
      LEFT JOIN TVKOT AS K ON K~VKORG = E~VKORG AND K~SPRAS = @SY-LANGU
      LEFT JOIN TVTWT AS L ON L~VTWEG = E~VTWEG AND L~SPRAS = 'E'
      LEFT JOIN /SAPAPO/MATGROUP AS M ON A~SCM_MATID_GUID22 = M~MATID
      LEFT JOIN MAPR AS O ON A~MATNR = O~MATNR
      LEFT JOIN PROP AS N ON O~PNUM1 = N~PNUM1
      LEFT JOIN QMAT AS P ON A~MATNR = P~MATNR
      LEFT JOIN TQ30T AS Q ON P~ART = Q~ART AND Q~SPRACHE = 'E'
      LEFT JOIN MARM AS R ON A~MATNR = R~MATNR
      left JOIN MARD AS S ON A~MATNR = S~MATNR

*      WHERE  a~matnr = '000000000000002887' "a~mtart = 'ZFG'"
      INTO TABLE @DATA(IT_MATERIALMASTER).

    SORT IT_MATERIALMASTER BY MATERIAL PLANT.
    DELETE ADJACENT DUPLICATES FROM IT_MATERIALMASTER COMPARING MATERIAL PLANT.


    LOOP AT IT_MATERIALMASTER ASSIGNING FIELD-SYMBOL(<WA_MM>).

      CLEAR : <WA_MM>-PRODUCTGROUPTYPEDESC,<WA_MM>-PRODUCTGROUPTYPEDESC1,<WA_MM>-PRODUCTGROUPTYPEDESC2,<WA_MM>-PRODUCTGROUPTYPEDESC3.
*      <wa_mm>-lastpricechange  =  |{ <wa_mm>-lastpricechange+0(4) }/{ <wa_mm>-lastpricechange+4(2) }/{ <wa_mm>-lastpricechange+6(2) }|.

      IF <WA_MM>-STANDARDPRICE IS NOT INITIAL.
        <WA_MM>-STANDARDPRICE  =  <WA_MM>-STANDARDPRICE / 100.
      ENDIF.
      IF <WA_MM>-PERUNITPRICE IS NOT INITIAL.
        <WA_MM>-PERUNITPRICE   =  <WA_MM>-PERUNITPRICE / 100.
      ENDIF.
      IF <WA_MM>-PREVIOUSPRICE IS NOT INITIAL.
        <WA_MM>-PREVIOUSPRICE   =  <WA_MM>-PREVIOUSPRICE / 100.
      ENDIF.

      REPLACE ALL OCCURRENCES OF '/' IN <WA_MM>-LASTPRICECHANGE WITH ''.
      REPLACE ALL OCCURRENCES OF '/' IN <WA_MM>-MATERIALGROUPNAME WITH ','.
      REPLACE ALL OCCURRENCES OF '/' IN <WA_MM>-EXTERNALMATERIALGROUPNAME WITH ','.

      CONDENSE : <WA_MM>-STANDARDPRICE, <WA_MM>-PERUNITPRICE,<WA_MM>-PREVIOUSPRICE,<WA_MM>-X,<WA_MM>-Y.

      SELECT SINGLE UMREZ,UMREN,MEINS,LMEIN FROM EINA INTO @DATA(WA_EINA) WHERE MATNR = @<WA_MM>-MATERIAL.
      <WA_MM>-X = WA_EINA-UMREN.
      <WA_MM>-AUN = WA_EINA-MEINS.
      <WA_MM>-Y = WA_EINA-UMREZ.
      <WA_MM>-BUN = WA_EINA-LMEIN.

      DATE =   <WA_MM>-LASTPRICECHANGE.


      """""""""""""""""""" product grp type """"""""""""""""""""""""""""""""

      SELECT SINGLE SCM_MATID_GUID22 FROM MARA INTO @DATA(WA_PSTAT) WHERE MATNR = @<WA_MM>-MATERIAL.
      SELECT SINGLE GRPTYPE,GROUPVALUE FROM /SAPAPO/MATGROUP INTO @DATA(WA_MARA) WHERE MATID = @WA_PSTAT AND GRPTYPE = 'CT'.
      <WA_MM>-PRODUCTGROUPTYPE       = WA_MARA-GRPTYPE.
      IF <WA_MM>-PRODUCTGROUPTYPE IS NOT INITIAL.
        <WA_MM>-PRODUCTGROUPTYPEDESC   = 'Component Type'.
      ENDIF.
      <WA_MM>-PRODUCTGROUP           = WA_MARA-GROUPVALUE.

      SELECT SINGLE GRPTYPE,GROUPVALUE FROM /SAPAPO/MATGROUP INTO @DATA(WA_MARA1) WHERE MATID = @WA_PSTAT AND GRPTYPE = 'MT'.
      <WA_MM>-PRODUCTGROUPTYPE1          = WA_MARA1-GRPTYPE.
      IF <WA_MM>-PRODUCTGROUPTYPE1 IS NOT INITIAL.
        <WA_MM>-PRODUCTGROUPTYPEDESC1   = 'Movement Type'.
      ENDIF.
      <WA_MM>-PRODUCTGROUP1              = WA_MARA1-GROUPVALUE.

      SELECT SINGLE GRPTYPE,GROUPVALUE FROM /SAPAPO/MATGROUP INTO @DATA(WA_MARA2) WHERE MATID = @WA_PSTAT AND GRPTYPE = 'PC'.
      <WA_MM>-PRODUCTGROUPTYPE2          = WA_MARA2-GRPTYPE.
      IF <WA_MM>-PRODUCTGROUPTYPE2 IS NOT INITIAL.
        <WA_MM>-PRODUCTGROUPTYPEDESC2   = 'plastic component'.
      ENDIF.
      <WA_MM>-PRODUCTGROUP2              = WA_MARA2-GROUPVALUE.

      SELECT SINGLE GRPTYPE,GROUPVALUE FROM /SAPAPO/MATGROUP INTO @DATA(WA_MARA3) WHERE MATID = @WA_PSTAT AND GRPTYPE = 'PT'.
      <WA_MM>-PRODUCTGROUPTYPE3          = WA_MARA3-GRPTYPE.
      IF <WA_MM>-PRODUCTGROUPTYPE3 IS NOT INITIAL.
        <WA_MM>-PRODUCTGROUPTYPEDESC3   = 'Wheeler type'.
      ENDIF.
      <WA_MM>-PRODUCTGROUP3              = WA_MARA3-GROUPVALUE.




      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          INPUT  = <WA_MM>-MATERIAL
        IMPORTING
          OUTPUT = <WA_MM>-MATERIAL.


    ENDLOOP.


    DATA(JSON_WRITER) = CL_SXML_STRING_WRITER=>CREATE(
                       TYPE = IF_SXML=>CO_XT_JSON ).
    CALL TRANSFORMATION ID SOURCE RESULT = IT_MATERIALMASTER
                           RESULT XML JSON_WRITER.
    DATA(JSON) = JSON_WRITER->GET_OUTPUT( ).

    DATA: LO_JSON_DATA TYPE REF TO ZCL_TREX_JSON_SERIALIZER,
          JSON1        TYPE STRING.

    CREATE OBJECT LO_JSON_DATA
      EXPORTING
        DATA = IT_MATERIALMASTER.

* serialize data

    LO_JSON_DATA->SERIALIZE( ).

* get serialized json data string

    JSON1 = LO_JSON_DATA->GET_DATA( ).

    SERVER->RESPONSE->SET_CDATA(
         DATA = JSON1 ).





  ENDMETHOD.
